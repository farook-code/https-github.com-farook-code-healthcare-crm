<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\ProfileController;
use App\Http\Controllers\Doctor\DashboardController;
use App\Http\Controllers\Doctor\DoctorAppointmentController;
use App\Http\Controllers\Reception\AppointmentController;
use App\Http\Controllers\Patient\DashboardController as PatientDashboardController;
use App\Http\Controllers\Patient\AppointmentController as PatientAppointmentController;
use App\Models\Appointment;
use App\Http\Controllers\Nurse\DashboardController as NurseDashboardController;
use App\Http\Controllers\LabReportController;

/*
|--------------------------------------------------------------------------
| Public Route
|--------------------------------------------------------------------------
*/
Route::get('/', function () {
    return view('welcome');
});

Route::middleware(['auth','role:nurse'])
    ->prefix('nurse')
    ->name('nurse.')
    ->group(function () {

        Route::get('/dashboard',
            [NurseDashboardController::class, 'index']
        )->name('dashboard');

    });

/*
|--------------------------------------------------------------------------
| Role-based Dashboards (STATIC – OPTIONAL)
|--------------------------------------------------------------------------
*/
Route::middleware(['auth'])->group(function () {

    Route::middleware(['role:admin'])->prefix('admin')->name('admin.')->group(function () {
        Route::get('/dashboard', function () {
            return view('dashboards.admin');
        })->name('dashboard');

        Route::get('/reports', [\App\Http\Controllers\Admin\ReportController::class, 'index'])
            ->name('reports.index');

        // Audit Logs (Simple closure for now or Controller)
        Route::get('/audit-logs', function () {
            $logs = \App\Models\AuditLog::with('user')->latest()->paginate(20);
            return view('admin.logs.index', compact('logs'));
        })->name('logs.index');
    });

    Route::get('/doctor/dashboard', function () {
        return view('dashboards.doctor');
    })->middleware('role:doctor');



    Route::get('/reception/dashboard', function () {
        return view('dashboards.reception');
    })->middleware('role:reception')
      ->name('reception.dashboard');

});

/*
|--------------------------------------------------------------------------
| Patient Module (CONTROLLER-BASED — CORRECT WAY)
|--------------------------------------------------------------------------
*/
Route::middleware(['auth'])
    ->prefix('patient')
    ->name('patient.')
    ->group(function () {

        Route::get('/dashboard', [PatientDashboardController::class, 'index'])
            ->name('dashboard');

        Route::get('/appointments', [PatientAppointmentController::class, 'index'])
            ->name('appointments.index');

        Route::get('/appointments/{appointment}', [PatientAppointmentController::class, 'show'])
            ->name('appointments.show');

        Route::get('/prescriptions',
    [\App\Http\Controllers\Patient\PrescriptionController::class, 'index']
)->name('prescriptions.index');

Route::get('/vitals',
            [\App\Http\Controllers\Patient\VitalController::class, 'index']
        )->name('vitals.index');

    });

/*
|--------------------------------------------------------------------------
| Profile
|--------------------------------------------------------------------------
*/
Route::middleware('auth')->group(function () {
    Route::get('/profile', [ProfileController::class, 'edit'])->name('profile.edit');
    Route::patch('/profile', [ProfileController::class, 'update'])->name('profile.update');
    Route::delete('/profile', [ProfileController::class, 'destroy'])->name('profile.destroy');
});

/*
|--------------------------------------------------------------------------
| Doctor Module
|--------------------------------------------------------------------------
*/
Route::middleware(['auth','role:doctor'])
    ->prefix('doctor')
    ->name('doctor.')
    ->group(function () {

        Route::get('/dashboard', [DashboardController::class, 'index'])
            ->name('dashboard');

        Route::get('/appointments', function () {
            $appointments = Appointment::where('doctor_id', auth()->id())
                ->latest()
                ->get();

            return view('doctors.appointments', compact('appointments'));
        })->name('appointments');

        Route::get('/appointments/{appointment}',
            [DoctorAppointmentController::class, 'show']
        )->name('appointments.show');

        Route::patch('/appointments/{appointment}/complete',
            [DoctorAppointmentController::class, 'complete']
        )->name('appointments.complete');
    });

/*
|--------------------------------------------------------------------------
| Diagnosis & Prescription
|--------------------------------------------------------------------------
*/
Route::get('/appointments/{appointment}/diagnosis',
    [DoctorAppointmentController::class, 'diagnosisForm']
)->name('doctors.appointments.diagnosis.form');

Route::post('/appointments/{appointment}/diagnosis',
    [DoctorAppointmentController::class, 'storeDiagnosis']
)->name('doctors.appointments.diagnosis.store');

Route::get('/diagnosis/{diagnosis}/prescription',
    [DoctorAppointmentController::class, 'prescriptionForm']
)->name('doctors.prescription.form');

Route::post('/diagnosis/{diagnosis}/prescription',
    [DoctorAppointmentController::class, 'storePrescription']
)->name('doctors.prescription.store');

/*
|--------------------------------------------------------------------------
| Reception Module
|--------------------------------------------------------------------------
*/
Route::middleware(['auth','role:reception'])
    ->prefix('reception')
    ->name('reception.')
    ->group(function () {

        Route::get('/appointments', [AppointmentController::class, 'index'])
            ->name('appointments.index');

        Route::get('/appointments/create', [AppointmentController::class, 'create'])
            ->name('appointments.create');

        Route::post('/appointments', [AppointmentController::class, 'store'])
            ->name('appointments.store');

        // Patient Registration
        Route::get('/patients/create', [\App\Http\Controllers\Reception\PatientController::class, 'create'])
            ->name('patients.create');
        Route::post('/patients', [\App\Http\Controllers\Reception\PatientController::class, 'store'])
            ->name('patients.store');

        // Billing
        Route::post('/appointments/{appointment}/invoice',
            [\App\Http\Controllers\Reception\InvoiceController::class, 'store']
        )->name('invoices.store');

        Route::patch('/invoices/{invoice}/pay',
            [\App\Http\Controllers\Reception\InvoiceController::class, 'markAsPaid']
        )->name('invoices.pay');
    });

    Route::middleware(['auth','role:nurse,doctor'])
    ->prefix('vitals')
    ->name('vitals.')
    ->group(function () {

        Route::get('/appointments/{appointment}/create',
            [\App\Http\Controllers\VitalController::class, 'create']
        )->name('create');

        Route::post('/appointments/{appointment}',
            [\App\Http\Controllers\VitalController::class, 'store']
        )->name('store');
    });



    Route::middleware(['auth','role:doctor|nurse'])
    ->group(function () {

        Route::get('/lab-reports/{appointment}/create',
            [LabReportController::class, 'create']
        )->name('lab-reports.create');

        Route::post('/lab-reports/{appointment}',
            [LabReportController::class, 'store']
        )->name('lab-reports.store');

        Route::get('/lab-reports/{labReport}/download',
            [LabReportController::class, 'download']
        )->name('lab-reports.download');

        Route::get('/patients/{patient}/medical-records',
            [LabReportController::class, 'index']
        )->name('lab-reports.index');
    });



require __DIR__.'/auth.php';
